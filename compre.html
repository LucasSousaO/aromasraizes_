<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#F2E3CE" />

  <title>Ra√≠zes Aromas ‚Ä¢ Montar pedido</title>
  <meta name="description" content="Monte seu pedido de velas veganas aromatizadas (30g e 110g) e finalize pelo WhatsApp." />
  <meta name="robots" content="index,follow" />
  
  <!-- Canonical (troque quando publicar no dom√≠nio final) -->
  <link rel="canonical" href="https://aromasraizes.com.br" />

  <!-- Favicon (troque pela URL final) -->
  <link rel="icon" href="assets/images/logo.png" />

  <!-- Open Graph / WhatsApp Preview -->
  <meta property="og:title" content="Ra√≠zes Aromas | Velas veganas aromatizadas" />
  <meta property="og:description" content="Presentes especiais e encomendas. Entregas em Atibaia e Belo Horizonte. Pe√ßa pelo WhatsApp ou Instagram." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://aromasraizes.com.br" />
  <meta property="og:image" content="assets/images/logo.png" />
  <meta property="og:locale" content="pt_BR" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PMVN86NGX7"></script>

  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PMVN86NGX7');

</script>
  <style>
    :root{
      /* Paleta enviada */
      --bg: #F2E3CE;      /* principal */
      --ink:#210124;      /* texto forte */
      --olive:#313715;    /* apoio */
      --orange:#D16014;   /* CTA */
      --card:#FAF2E6;
      --line: rgba(33,1,36,.18);
      --shadow: 0 18px 55px rgba(33,1,36,.12);
      --r: 18px;
      --max: 1100px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 20% 10%, rgba(209,96,20,.12), transparent 55%),
                  radial-gradient(900px 500px at 90% 20%, rgba(49,55,21,.10), transparent 55%),
                  var(--bg);
      color: var(--ink);
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:22px 18px 70px;}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border:1px solid var(--line);
      background: rgba(250,242,230,.75);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 50;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      text-decoration:none;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(209,96,20,.35), rgba(49,55,21,.22));
      border:1px solid var(--line);
      display:grid; place-items:center;
      font-weight:900;
      color: var(--ink);
    }
    .brand b{display:block; font-size:14px; letter-spacing:.2px}
    .brand span{display:block; font-size:12px; color: rgba(33,1,36,.70)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(250,242,230,.9);
      text-decoration:none;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(250,242,230,1);}
    .btn.primary{
      background: var(--orange);
      border-color: rgba(0,0,0,.05);
      color: #fff;
    }
    .btn.primary:hover{filter: brightness(1.03);}

    h1{
      margin:18px 0 8px;
      font-size: clamp(24px, 3.6vw, 40px);
      letter-spacing: -0.6px;
      line-height: 1.05;
    }
    .sub{
      margin:0 0 18px;
      color: rgba(33,1,36,.78);
      max-width: 70ch;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:start;
      margin-top: 14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns: 1fr;}
      .top{position: static;}
    }

    .panel{
      border:1px solid var(--line);
      background: rgba(250,242,230,.7);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .panelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
    }
    .panelHead h2{margin:0; font-size:16px}
    .panelHead p{margin:0; font-size:12px; color: rgba(33,1,36,.72)}

    .items{padding:14px; display:grid; gap:12px;}
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.35);
      border-radius: 16px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .itemTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .item b{font-size:14px}
    .item .desc{font-size:12px; color: rgba(33,1,36,.72); margin-top:3px}

    .qtyRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 520px){
      .qtyRow{grid-template-columns: 1fr;}
    }

    .qtyBox{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(250,242,230,.65);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .qtyBox .label{
      display:flex; flex-direction:column;
    }
    .qtyBox .label span{font-size:12px; color: rgba(33,1,36,.7)}
    .qtyBox .label b{font-size:13px}
    .stepper{
      display:flex; align-items:center; gap:8px;
    }
    .iconBtn{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.55);
      cursor:pointer;
      font-size:18px;
      font-weight:900;
      line-height: 1;
    }
    .iconBtn:active{transform: scale(.98);}
    input.qty{
      width:56px;
      height:34px;
      border-radius: 12px;
      border:1px solid var(--line);
      text-align:center;
      font-weight:800;
      background: rgba(255,255,255,.65);
      color: var(--ink);
      outline:none;
    }

    /* Resumo */
    .summary{
      padding:14px;
      display:grid;
      gap: 12px;
    }
    .field{
      display:grid;
      gap:6px;
    }
    label{font-size:12px; color: rgba(33,1,36,.75); font-weight:700}
    select, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid var(--line);
      padding:10px 12px;
      background: rgba(255,255,255,.6);
      color: var(--ink);
      font: inherit;
      outline:none;
    }
    textarea{min-height: 80px; resize: vertical;}

    .totals{
      border:1px dashed rgba(33,1,36,.28);
      background: rgba(250,242,230,.7);
      border-radius: 16px;
      padding:12px;
      font-size: 13px;
      color: rgba(33,1,36,.85);
      display:grid;
      gap:6px;
    }
    .totals b{color: var(--ink);}
    .hint{font-size:12px; color: rgba(33,1,36,.72);}

    .footerRow{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .mutedLink{font-size:12px; color: rgba(33,1,36,.75);}

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.35);
      font-size:12px;
      color: rgba(33,1,36,.80);
    }
  </style>
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "uv9oeyq093");
</script>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <a class="brand" href="./index.html" aria-label="Voltar para a p√°gina inicial">
        
        <img src="assets/images/logo.png" alt="Ra√≠zes Aromas" style="width:42px;height:42px;border-radius:14px;object-fit:cover;border:1px solid rgba(33,1,36,.18)">
        <div>
          <b>Ra√≠zes Aromas</b>
          <span>Velas veganas aromatizadas</span>
        </div>
      </a>
      <div style="display:flex; gap:10px; align-items:center;">
        <span class="pill">üìç Atibaia/SP BH/MG</span>
        <a class="btn" id="backtoInstagram" href="https://www.instagram.com/raizesaromas_/" target="_blank" rel="noopener">Ver Instagram</a>
      </div>
    </header>

    <h1>Monte seu pedido</h1>
    <p class="sub">
      Escolha as quantidades por aroma e tamanho (30g e 110g). No final, clique em <b>fazer pedido no WhatsApp</b> e a mensagem vai pronta. üíõ
    </p>

    <div class="grid">
      <!-- LISTA DE PRODUTOS -->
      <section class="panel" aria-label="Produtos">
        <div class="panelHead">
          <div>
            <h2>Aromas</h2>
            <p>Fixos + possibilidades extras</p>
          </div>
          <button class="btn" type="button" id="btnZerar">Zerar tudo</button>
        </div>

        <div class="items" id="items"></div>
      </section>

      <!-- RESUMO / CHECKOUT -->
      <aside class="panel" aria-label="Resumo do pedido">
        <div class="panelHead">
          <div>
            <h2>Resumo</h2>
            <p>Fechar pedido por WhatsApp</p>
          </div>
        </div>

        <div class="summary">

<div class="field">
  <label for="local">Local de retirada/entrega</label>
  <select id="local">
    <option value="Atibaia">Atibaia</option>
    <option value="Belo Horizonte">Belo Horizonte</option>
    <option value="Frete">Frete</option>
  </select>
</div>

<!-- Bloco do frete (fica escondido at√© selecionar "Frete") -->
<div id="freteArea" class="field" style="display:none;">
  <label><b>Calcular frete</b></label>

  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <input id="cepInput" class="field" type="text" inputmode="numeric" placeholder="00000-000" maxlength="9" />
    <button class="btn" id="btnCalcularFrete" type="button">Calcular</button>
  </div>

  <div id="freteStatus" style="margin-top:8px; font-size:14px;"></div>

  <div id="freteResultados" style="display:none; margin-top:10px; padding:10px; border:1px solid #eee; border-radius:8px;">
  <div style="margin-bottom:6px;"><b>Selecione uma op√ß√£o (obrigat√≥rio):</b></div>

  <label style="display:flex; gap:8px; align-items:center; padding:8px; border:1px solid #f0f0f0; border-radius:8px; margin-bottom:8px;">
    <input type="radio" name="freteOpcao" value="PAC">
    <span id="pacLabel">PAC ‚Äî ...</span>
  </label>

  <label style="display:flex; gap:8px; align-items:center; padding:8px; border:1px solid #f0f0f0; border-radius:8px;">
    <input type="radio" name="freteOpcao" value="SEDEX">
    <span id="sedexLabel">SEDEX ‚Äî ...</span>
  </label>
</div>

</div>
<div class="totals" id="totals">
  <div><b>30g:</b> <span id="t30">0</span> un</div>
  <div><b>110g:</b> <span id="t110">0</span> un</div>
  <div class="hint">Pre√ßos (informativo): 30g R$15 ‚Ä¢ 110g R$60</div>

  <div id="totaisValores" style="margin-top:6px; border-top:1px dashed rgba(33,1,36,.22); padding-top:8px;">
    <div><b>Subtotal produtos:</b> <span id="subtotalProdutos">R$ 0,00</span></div>
    <div id="linhaFrete"><b>Frete:</b> <span id="subtotalFrete">‚Äî</span></div>
    <div style="margin-top:6px; font-size:14px;">
      <b>Total estimado:</b> <span id="totalEstimado">R$ 0,00</span>
    </div>
  </div>
</div>


          <div class="field">
            <label for="observacao">Observa√ß√£o (opcional)</label>
            <textarea id="observacao" placeholder="Ex.: √© presente, quero um aroma mais suave, entregar at√© sexta, etc."></textarea>
          </div>


          <button class="btn primary" type="button" id="btnWhatsapp">
            Fazer pedido no WhatsApp
          </button>

          <div class="footerRow">
            <span class="mutedLink">Feito por um jovem casal empreendendo para casar üíç</span>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/**
 * =========================================================
 *  Ra√≠zes Aromas ‚Äî compre.html (JS organizado)
 *  - Carrinho (quantidades por aroma / 30g e 110g)
 *  - Frete (API) + filtro de op√ß√µes sem pre√ßo
 *  - Total estimado (Produtos + Frete somente quando "Frete")
 *  - WhatsApp: valida frete (CEP + PAC/SEDEX) quando selecionado
 *  - GA4: eventos b√°sicos (opcional, s√≥ dispara se gtag existir)
 * =========================================================
 */

/* =========================
   CONFIG
========================= */
const WHATSAPP_PHONE = "5511944800174"; // sem "+" e sem espa√ßos
const FRETE_API_URL = "https://aromasraizesapi.vercel.app/api/frete";

const PRECO_30G = 15;
const PRECO_110G = 60;

const PRODUCTS = [
  { id: "lavanda", name: "Lavanda", desc: "Conforto e calmaria. √ìtima para relaxar." },
  { id: "bamboo", name: "Bamboo", desc: "Fresco e leve. Sensa√ß√£o de ambiente limpo." },
  { id: "morango_champagne", name: "Morango & Champagne", desc: "Doce e celebrativo. Presente com ‚Äúuau‚Äù." },
  { id: "baunilha", name: "Baunilha", desc: "Doce e aconchegante." },
  { id: "flor_cerejeira", name: "Flor de Cerejeira", desc: "Delicada e elegante." },
  { id: "ameixa", name: "Ameixa", desc: "Marcante e sofisticada." },
];

/* =========================
   STATE
========================= */
// Carrinho por aroma
const state = Object.fromEntries(PRODUCTS.map(p => [p.id, { q30: 0, q110: 0 }]));

// Frete
const freteState = {
  cepMasked: "",
  pac: null,   // { price:number, delivery_time:number }
  sedex: null, // { price:number, delivery_time:number }
  escolhido: null // "PAC" | "SEDEX"
};

let lastEntrega = null; // GA4: evita eventos duplicados no select

/* =========================
   HELPERS
========================= */
function onlyDigits(s){ return String(s || "").replace(/\D/g, ""); }

function clampInt(v){
  const n = parseInt(v, 10);
  return Number.isFinite(n) && n >= 0 ? n : 0;
}

function formatBRL(value){
  const n = Number(value);
  if (Number.isNaN(n)) return String(value);
  return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
}

function safeGtag(eventName, params){
  if (window.gtag) window.gtag("event", eventName, params || {});
}

/* =========================
   DOM REFS
========================= */
const $items = document.getElementById("items");
const $t30 = document.getElementById("t30");
const $t110 = document.getElementById("t110");

const $local = document.getElementById("local");
const $freteArea = document.getElementById("freteArea");
const $cepInput = document.getElementById("cepInput");
const $btnCalcularFrete = document.getElementById("btnCalcularFrete");
const $freteStatus = document.getElementById("freteStatus");
const $freteResultados = document.getElementById("freteResultados");

const $pacLabel = document.getElementById("pacLabel");
const $sedexLabel = document.getElementById("sedexLabel");

const $btnWhatsapp = document.getElementById("btnWhatsapp");
const $btnZerar = document.getElementById("btnZerar");
const $observacao = document.getElementById("observacao");

const $totaisValores = document.getElementById("totaisValores");
const $linhaFrete = document.getElementById("linhaFrete");
const $subtotalProdutos = document.getElementById("subtotalProdutos");
const $subtotalFrete = document.getElementById("subtotalFrete");
const $totalEstimado = document.getElementById("totalEstimado");

/* =========================
   CARRINHO UI
========================= */
function renderQtyBox(id, key, title, subtitle, value){
  return `
    <div class="qtyBox" aria-label="${title}">
      <div class="label">
        <b>${title}</b>
        <span>${subtitle}</span>
      </div>
      <div class="stepper">
        <button class="iconBtn" type="button" aria-label="Diminuir"
          data-action="dec" data-id="${id}" data-key="${key}">‚àí</button>
        <input class="qty" inputmode="numeric" pattern="[0-9]*"
          aria-label="Quantidade ${title}" value="${value}"
          data-id="${id}" data-key="${key}">
        <button class="iconBtn" type="button" aria-label="Aumentar"
          data-action="inc" data-id="${id}" data-key="${key}">+</button>
      </div>
    </div>
  `;
}

function step(id, key, action){
  const cur = state[id][key];
  state[id][key] = action === "inc" ? cur + 1 : Math.max(0, cur - 1);

  const inp = document.querySelector(`input.qty[data-id="${id}"][data-key="${key}"]`);
  if (inp) inp.value = state[id][key];

  updateTotals();
}

function render(){
  if (!$items) return;

  $items.innerHTML = PRODUCTS.map(p => {
    const s = state[p.id];
    return `
      <article class="item" data-id="${p.id}">
        <div class="itemTop">
          <div>
            <b>${p.name}</b>
            <div class="desc">${p.desc}</div>
          </div>
        </div>

        <div class="qtyRow">
          ${renderQtyBox(p.id, "q30", "30g", "Vela pequena", s.q30)}
          ${renderQtyBox(p.id, "q110", "110g", "Vela grande", s.q110)}
        </div>
      </article>
    `;
  }).join("");

  // Eventos: + e -
  document.querySelectorAll("[data-action]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      const key = btn.getAttribute("data-key");
      const action = btn.getAttribute("data-action");
      step(id, key, action);
    });
  });

  // Eventos: input manual
  document.querySelectorAll("input.qty").forEach(inp => {
    inp.addEventListener("input", () => {
      const id = inp.getAttribute("data-id");
      const key = inp.getAttribute("data-key");
      state[id][key] = clampInt(inp.value);
      updateTotals();
    });
  });

  updateTotals();
}

function updateTotals(){
  let total30 = 0, total110 = 0;

  for (const s of Object.values(state)){
    total30 += s.q30;
    total110 += s.q110;
  }

  if ($t30) $t30.textContent = total30;
  if ($t110) $t110.textContent = total110;

  updateResumoValores();
}

/* =========================
   TOTAL ESTIMADO
========================= */
function calcSubtotalProdutos(){
  let total30 = 0, total110 = 0;
  for (const s of Object.values(state)) {
    total30 += Number(s.q30 || 0);
    total110 += Number(s.q110 || 0);
  }
  return (total30 * PRECO_30G) + (total110 * PRECO_110G);
}

function calcFreteSelecionado(){
  if (!freteState.escolhido) return null;
  const info = (freteState.escolhido === "PAC") ? freteState.pac : freteState.sedex;
  if (!info || !Number.isFinite(Number(info.price))) return null;
  return Number(info.price);
}

function updateResumoValores(){
  const local = ($local?.value || "").trim();

  // n√£o deixa quebrar caso os spans n√£o existam (mas ideal √© existir)
  if (!$subtotalProdutos || !$totalEstimado || !$totaisValores) return;

  const subtotal = calcSubtotalProdutos();
  $subtotalProdutos.textContent = formatBRL(subtotal);

  // Se n√£o for Frete: esconde linha frete e total = subtotal
  if (local !== "Frete") {
    if ($linhaFrete) $linhaFrete.style.display = "none";
    if ($subtotalFrete) $subtotalFrete.textContent = "‚Äî";
    $totalEstimado.textContent = formatBRL(subtotal);
    return;
  }

  // Se for Frete: mostra linha frete
  if ($linhaFrete) $linhaFrete.style.display = "block";

  const frete = calcFreteSelecionado();
  if (frete == null) {
    if ($subtotalFrete) $subtotalFrete.textContent = "Selecione PAC ou SEDEX";
    $totalEstimado.textContent = formatBRL(subtotal);
    return;
  }

  if ($subtotalFrete) $subtotalFrete.textContent = formatBRL(frete);
  $totalEstimado.textContent = formatBRL(subtotal + frete);
}

/* =========================
   FRETE (UI + API)
========================= */
function attachCepMask(){
  if (!$cepInput) return;
  $cepInput.addEventListener("input", () => {
    let v = onlyDigits($cepInput.value).slice(0, 8);
    if (v.length > 5) v = v.slice(0, 5) + "-" + v.slice(5);
    $cepInput.value = v;
  });
}

function resetFreteStateAndUI(){
  freteState.cepMasked = "";
  freteState.pac = null;
  freteState.sedex = null;
  freteState.escolhido = null;

  if ($freteStatus) $freteStatus.textContent = "";
  if ($freteResultados) $freteResultados.style.display = "none";

  document.querySelectorAll('input[name="freteOpcao"]').forEach(r => (r.checked = false));

  // reexibe as linhas caso voc√™ tenha ocultado antes
  const pacRow = document.querySelector('input[name="freteOpcao"][value="PAC"]')?.closest("label");
  const sedexRow = document.querySelector('input[name="freteOpcao"][value="SEDEX"]')?.closest("label");
  if (pacRow) pacRow.style.display = "flex";
  if (sedexRow) sedexRow.style.display = "flex";
}

function showFreteAreaIfNeeded(){
  if (!$local || !$freteArea) return;

  const localRaw = ($local.value || "").trim();
  const local = localRaw.toLowerCase();
  const isFrete = local === "frete";

  // GA4: evento s√≥ se mudou
  if (localRaw !== lastEntrega) {
    safeGtag("select_entrega", { method: localRaw });
    lastEntrega = localRaw;
  }

  $freteArea.style.display = isFrete ? "block" : "none";

  if (!isFrete) {
    resetFreteStateAndUI();
  }

  updateResumoValores();
}

function getCartProductsForFreight(){
  let q30 = 0, q110 = 0;
  for (const s of Object.values(state)) {
    q30 += Number(s.q30 || 0);
    q110 += Number(s.q110 || 0);
  }

  const products = [];
  if (q30 > 0) products.push({
    id: "vela_30g",
    width: 8, height: 5, length: 8,
    weight: 0.06, insurance_value: 15,
    quantity: q30
  });
  if (q110 > 0) products.push({
    id: "vela_110g",
    width: 10, height: 6, length: 10,
    weight: 0.15, insurance_value: 60,
    quantity: q110
  });

  return products;
}

function findPacSedex(options){
  const pac = options.find(o => /pac/i.test(o.name));
  const sedex = options.find(o => /sedex/i.test(o.name));
  return { pac, sedex };
}

function bindFreteChoice(){
  document.querySelectorAll('input[name="freteOpcao"]').forEach(radio => {
    radio.addEventListener("change", () => {
      freteState.escolhido = radio.value; // "PAC" | "SEDEX"
      safeGtag("frete_opcao", { service: radio.value });
      updateResumoValores();
    });
  });
}

async function calcularFrete(){
  const cepMasked = ($cepInput?.value || "").trim();
  const cep = onlyDigits(cepMasked);

  if (!$freteStatus || !$freteResultados) return;

  if (cep.length !== 8) {
    $freteStatus.textContent = "Informe um CEP v√°lido (00000-000).";
    $freteResultados.style.display = "none";
    return;
  }

  const products = getCartProductsForFreight();
  if (!products.length) {
    $freteStatus.textContent = "Adicione itens no carrinho antes de calcular o frete.";
    $freteResultados.style.display = "none";
    return;
  }

  $freteStatus.textContent = "Calculando frete...";
  $freteResultados.style.display = "none";

  try {
    const resp = await fetch(FRETE_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ toPostalCode: cep, products })
    });

    const data = await resp.json();

    if (!resp.ok) {
      console.error("Erro frete:", data);
      $freteStatus.textContent = "N√£o foi poss√≠vel calcular o frete agora. Tente novamente.";
      return;
    }

    // normaliza e filtra op√ß√µes sem pre√ßo (ou pre√ßo 0 / NaN)
    const options = (data.options || [])
      .map(o => ({
        name: String(o.name || o.service || o.service_name || ""),
        price: Number(o.price ?? o.custom_price),
        delivery_time: Number(o.delivery_time ?? o.custom_delivery_time)
      }))
      .filter(o => Number.isFinite(o.price) && o.price > 0);

    const { pac, sedex } = findPacSedex(options);

    // se n√£o tem nenhuma op√ß√£o v√°lida, aborta
    if (!pac && !sedex) {
      resetFreteStateAndUI();
      $freteStatus.textContent = "Nenhuma op√ß√£o de frete dispon√≠vel para este CEP.";
      return;
    }

    // guarda CEP e reseta escolha
    freteState.cepMasked = cepMasked;
    freteState.escolhido = null;

    // pega linhas para esconder/exibir
    const pacRow = document.querySelector('input[name="freteOpcao"][value="PAC"]')?.closest("label");
    const sedexRow = document.querySelector('input[name="freteOpcao"][value="SEDEX"]')?.closest("label");

    // PAC
    if (pac) {
      if ($pacLabel) $pacLabel.textContent = `PAC ‚Äî ${formatBRL(pac.price)} ‚Ä¢ ${pac.delivery_time} dia(s)`;
      if (pacRow) pacRow.style.display = "flex";
      freteState.pac = { price: pac.price, delivery_time: pac.delivery_time };
    } else {
      if (pacRow) pacRow.style.display = "none";
      freteState.pac = null;
    }

    // SEDEX
    if (sedex) {
      if ($sedexLabel) $sedexLabel.textContent = `SEDEX ‚Äî ${formatBRL(sedex.price)} ‚Ä¢ ${sedex.delivery_time} dia(s)`;
      if (sedexRow) sedexRow.style.display = "flex";
      freteState.sedex = { price: sedex.price, delivery_time: sedex.delivery_time };
    } else {
      if (sedexRow) sedexRow.style.display = "none";
      freteState.sedex = null;
    }

    // limpa checks
    document.querySelectorAll('input[name="freteOpcao"]').forEach(r => (r.checked = false));

    // se s√≥ existe 1 op√ß√£o v√°lida, auto-seleciona
    if (pac && !sedex) {
      const r = document.querySelector('input[name="freteOpcao"][value="PAC"]');
      if (r) r.checked = true;
      freteState.escolhido = "PAC";
    }
    if (sedex && !pac) {
      const r = document.querySelector('input[name="freteOpcao"][value="SEDEX"]');
      if (r) r.checked = true;
      freteState.escolhido = "SEDEX";
    }

    // UI final
    $freteResultados.style.display = "block";
    $freteStatus.textContent =
      (pac && sedex) ? "Frete calculado. Selecione PAC ou SEDEX (obrigat√≥rio)." : "Frete calculado.";

    safeGtag("frete_calculado", { cep_prefix: cep.slice(0, 5) });

    updateResumoValores();

  } catch (e) {
    console.error(e);
    $freteStatus.textContent = "Erro ao calcular. Verifique sua conex√£o e tente novamente.";
  }
}

/* =========================
   WHATSAPP (mensagem)
========================= */
function getEntregaTextForWhatsApp(){
  const local = ($local?.value || "").trim();

  if (local === "Atibaia") return "Local de retirada/entrega: Retirada em Atibaia";
  if (local === "Belo Horizonte") return "Local de retirada/entrega: Retirada em Belo Horizonte";

  // Frete
  if (local === "Frete") {
    if (!freteState.cepMasked || !freteState.escolhido) return null;
    const info = (freteState.escolhido === "PAC") ? freteState.pac : freteState.sedex;
    if (!info) return null;

    return [
      "Local de retirada/entrega: Frete (Correios)",
      `CEP: ${freteState.cepMasked}`,
      `Servi√ßo: ${freteState.escolhido}`,
      `Valor do frete: ${formatBRL(info.price)}`,
      `Prazo: ${info.delivery_time} dia(s)`
    ].join("\n");
  }

  return `Local de retirada/entrega: ${local}`;
}

function buildMessage(){
  const local = ($local?.value || "").trim();
  const obs = ($observacao?.value || "").trim();

  const lines30 = [];
  const lines110 = [];

  for (const p of PRODUCTS){
    const s = state[p.id];
    if (s.q30 > 0) lines30.push(`- ${p.name}: ${s.q30} un`);
    if (s.q110 > 0) lines110.push(`- ${p.name}: ${s.q110} un`);
  }

  const hasAny = lines30.length || lines110.length;
  const header = `Ol√°! Quero fazer um pedido da Ra√≠zes Aromas üåøüïØÔ∏è`;

  // entrega (com valida√ß√£o de frete)
  const entregaTxt = getEntregaTextForWhatsApp();
  if (local === "Frete" && !entregaTxt) {
    alert("Para Frete, informe o CEP, calcule e selecione PAC ou SEDEX.");
    return null;
  }

  const sizes =
    `\nüì¶ Itens:\n` +
    (lines30.length ? `\n30g:\n${lines30.join("\n")}\n` : `\n30g: (nenhum)\n`) +
    (lines110.length ? `\n110g:\n${lines110.join("\n")}\n` : `\n110g: (nenhum)\n`);

  const story = `\nüíõ Vi a hist√≥ria de voc√™s e quero apoiar o projeto do casal!`;
  const obsBlock = obs ? `\nüìù Observa√ß√£o: ${obs}` : "";
  const closing = `\n\nObrigad@!`;

  if (!hasAny){
    return `${header}\n${entregaTxt}\n\nQuero ajuda para escolher um aroma e tamanho üôÇ${story}${obsBlock}${closing}`;
  }

  return `${header}\n${entregaTxt}${sizes}${story}${obsBlock}${closing}`;
}

function goWhatsApp(){
  safeGtag("whatsapp_click", { event_category: "engagement", event_label: "Fazer pedido" });

  const msg = buildMessage();
  if (!msg) return;

  const url = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank", "noopener");
}

/* =========================
   EVENTS / INIT
========================= */
function bindEvents(){
  $btnWhatsapp?.addEventListener("click", goWhatsApp);

  $btnZerar?.addEventListener("click", () => {
    for (const p of PRODUCTS){
      state[p.id].q30 = 0;
      state[p.id].q110 = 0;
    }
    document.querySelectorAll("input.qty").forEach(inp => (inp.value = 0));
    updateTotals();
  });

  $local?.addEventListener("change", showFreteAreaIfNeeded);
  $btnCalcularFrete?.addEventListener("click", calcularFrete);

  // radios (bind 1x)
  bindFreteChoice();

  // CEP mask
  attachCepMask();

  // inicial
  showFreteAreaIfNeeded();
  updateResumoValores();
}

document.addEventListener("DOMContentLoaded", () => {
  render();
  bindEvents();
});
</script>

</body>
</html>
